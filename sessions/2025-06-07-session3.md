# 2025-06-07 세션 3: OCR 프로젝트 설계 및 구현 방식 결정

## 작업 배경

### 문제 상황
- DETECT 채널에 2개의 이미지가 첨부되어 들어오는 경우 존재
- 첫 번째 이미지: 갓팩/특수 카드 스크린샷
- 두 번째 이미지: **팩을 연 계정의 아이디와 친구 코드 정보**
- 현재는 텍스트 메시지에서만 정보 추출 (이미지 정보 미활용)
- GISTAdapter의 inform 딕셔너리에서 name과 code가 누락될 수 있음

### 목표
- 두 번째 이미지에서 OCR로 계정 정보(name, code) 추출
- 3가지 OCR 라이브러리 성능 비교 후 최적 솔루션 선택
- Poke.py의 GISTAdapter에 통합

## OCR 처리 방식 논의 과정

### 1단계: 초기 고민 - 비동기 처리의 문제점
처음에는 비동기 처리를 고려했으나 다음과 같은 문제 제기:
- **디버깅의 어려움**: 비동기 코드는 실행 흐름 추적이 복잡
- **에러 처리**: 예외 발생 시 원인 파악 어려움
- **큐 vs 리스트**: 구현 방식보다 디버깅 용이성이 더 중요

### 2단계: 다양한 처리 방식 검토

#### 검토한 방식들:
1. **동기식 처리**: 단순하지만 봇이 멈춤
2. **subprocess.Popen**: Fire and forget 방식
3. **threading**: GIL 문제와 디버깅 어려움
4. **asyncio**: Discord.py와 통합은 좋지만 복잡
5. **별도 프로그램**: 완전 분리, 안정적

#### 상세 비교표:
| 방법 | 봇 멈춤 | 구현 복잡도 | 디버깅 | 장점 | 단점 |
|------|---------|------------|---------|------|------|
| 동기 (기본) | ❌ 멈춤 | ⭐ 쉬움 | ⭐⭐⭐ 쉬움 | • 코드 단순<br>• 에러 추적 용이 | • OCR 중 봇 정지 |
| subprocess.Popen | ✅ 안멈춤 | ⭐⭐ 보통 | ⭐⭐ 보통 | • 프로세스 격리<br>• 크래시 영향 없음 | • 프로세스 간 통신 필요 |
| threading | ✅ 안멈춤 | ⭐⭐ 보통 | ⭐ 어려움 | • 메모리 공유 가능 | • GIL 제약<br>• 디버깅 어려움 |
| asyncio | ✅ 안멈춤 | ⭐⭐⭐ 복잡 | ⭐ 어려움 | • 효율적인 I/O | • 복잡한 에러 처리 |
| 별도 프로그램 | ✅ 안멈춤 | ⭐⭐ 보통 | ⭐⭐⭐ 쉬움 | • 완전 분리<br>• 안정적 | • 별도 관리 필요 |

### 3단계: 핵심 이슈 파악

#### 타이밍 문제
- OCR 결과를 기다렸다가 포스팅해야 함
- 타임아웃은 사용하고 싶지 않음 (OCR 시간이 가변적)
- 즉시 포스팅 후 수정하는 방식은 비선호

#### 기술적 제약
- 추가 프로그램 설치 최소화 (Redis, RabbitMQ 등 제외)
- Windows/Mac 크로스 플랫폼 호환성 필요
- 봇을 가볍게 유지

### 4단계: 최종 해결책 도출

#### 핵심 아이디어
"OCR을 모듈로 만들어 독립적으로 디버깅하고, 큐에 작업을 넣은 후 주기적으로(5초) 완료 확인"

#### 장점
1. **모듈화**: OCR 로직을 독립적으로 테스트 가능
2. **디버깅 용이**: 각 단계별 파일로 상태 확인
3. **봇 안 멈춤**: OCR은 별도 프로세스에서 실행
4. **실패 복구**: 파일 기반이라 재시작 후도 처리 가능
5. **확장 가능**: 여러 OCR 워커 동시 실행 가능

## 최종 설계

### 아키텍처
```
Poke.py (메인 봇)
    ↓ (메시지 수신)
GISTAdapter.found_GodPack()
    ↓ (OCR 필요 시)
OCRProcessor.add_to_queue()
    ↓ (파일 저장 + Popen)
process_single_ocr.py (별도 프로세스)
    ↓ (OCR 수행)
ocr_completed/ 디렉토리에 결과 저장
    ↓
Poke.py의 5초 주기 체크
    ↓ (완료 확인)
포럼에 포스팅
```

### 디렉토리 구조
```
ocr_queue/         # OCR 대기 작업
├── {message_id}.json
ocr_completed/     # OCR 완료 결과
├── {message_id}.json
scripts/
├── process_single_ocr.py  # OCR 워커
modules/
├── ocr_module.py  # OCR 프로세서 클래스
```

### 데이터 흐름
1. **메시지 수신**: 2개 이미지 첨부 확인
2. **큐 등록**: OCR 작업을 `ocr_queue/`에 JSON으로 저장
3. **워커 실행**: subprocess.Popen으로 즉시 리턴
4. **OCR 처리**: 별도 프로세스에서 수행
5. **결과 저장**: `ocr_completed/`에 저장
6. **주기적 확인**: 5초마다 완료된 작업 확인
7. **포스팅**: 완료된 작업 발견 시 포럼에 게시

### 구현 세부사항

#### OCRProcessor 클래스
- `add_to_queue()`: 작업 추가 및 워커 실행
- `check_completed()`: 완료된 작업 확인 및 반환

#### GISTAdapter 수정
- 이미지 2개 있을 때 OCR 큐에 추가
- OCR 대기 중에는 None 반환 (포스팅 하지 않음)

#### Poke.py 수정
- `@tasks.loop(seconds=5)` 데코레이터로 주기적 확인
- 완료된 OCR 결과로 포스팅 생성

## 구현 시 주의사항

1. **파일 경로**: Windows/Mac 호환을 위해 os.path.join 사용
2. **동시성**: 여러 메시지가 동시에 들어와도 안전하게 처리
3. **에러 처리**: OCR 실패 시에도 봇이 멈추지 않도록
4. **정리 작업**: 처리 완료된 파일은 즉시 삭제

## 다음 작업

1. OCR 라이브러리 3종 테스트 환경 구축
2. OCRProcessor 모듈 구현
3. 단위 테스트 작성
4. GISTAdapter 통합
5. Poke.py에 주기적 확인 로직 추가

## 미해결 질문

- OCR 실패 시 재시도 로직이 필요한가?
- 오래된 큐 항목 자동 정리 필요성?
- OCR 결과 로깅 수준은?

## 구현 작업 내용 (2025-06-07 오후)

### 1. OCR 엔진 테스트 및 비교

#### 테스트 스크립트 구현
- `scripts/ocr/test_ocr_comparison.py` 작성
- 3가지 OCR 엔진 비교: Tesseract, EasyOCR, PaddleOCR (Vision.framework 추가)
- 로깅 시스템 구축 (디버그 모드 지원)

#### 테스트 결과
1. **Tesseract**
   - 이름: 0% 정확도
   - 친구코드: 0% 정확도
   - 속도: 가장 빠름 (0.14초)
   - 문제: 한국어/영어 혼재 이미지에서 성능 저하

2. **EasyOCR** ⭐ 최고 성능
   - 이름: 33.3% 정확도
   - 친구코드: 100% 정확도 ✅
   - 속도: 중간 (0.32초)
   - 문자 인식 오류: 0→o, 1→I

3. **PaddleOCR**
   - Apple Silicon Mac에서 MKLDNN 문제로 작동 불가
   - 대신 macOS Vision.framework 도입

4. **Vision.framework** (Apple Silicon 최적화)
   - 이름: 66.7% 정확도
   - 친구코드: 66.7% 정확도
   - 속도: 빠름 (평균 0.57초, 최소 0.05초)
   - 장점: Apple Silicon 네이티브, 빠른 속도

### 2. 테스트 데이터 생성

#### 테스트 케이스 추출 스크립트
- `scripts/ocr/extract_test_cases.py` 구현
- media.txt, media2.txt 파일에서 FRIENDCODE 이미지 정보 파싱
- 총 161개 테스트 케이스 추출 성공

#### 발견된 문제
- 기존 시스템이 한글 사용자명을 제대로 처리하지 못함
- '넅', '년' 같은 잘못된 한글 문자로 저장됨
- 이것이 OCR 도입의 주요 이유 중 하나임
- 한글 사용자명은 OCR로도 추출 불가능하므로 UNKNOWN 처리 필요

### 3. 향후 작업 계획

#### 남은 작업
1. OCRProcessor 모듈 구현
2. process_single_ocr.py 워커 스크립트 구현
3. GISTAdapter에 OCR 통합
4. Poke.py에 5초 주기 OCR 체크 로직 추가

#### 상호 보완 전략
- 주 엔진: EasyOCR (친구코드 100% 정확도)
- 보조 엔진: Vision.framework (빠른 속도, 이름 정확도 높음)
- 문자 보정 로직 필요 (0↔o, 1↔I 등)

### 4. 중요 인사이트
- OCR 도입 이유: 기존 시스템의 한글 처리 문제 해결
- 하지만 OCR도 한글은 제대로 인식하지 못함
- 영문 사용자명과 친구코드 추출에 집중
- 파일 기반 큐 시스템으로 비동기 처리 구현 예정

## 세션 중단 - Hotfix 작업 필요
- barrack 명령어 오류 수정을 위해 hotfix/barrack 브랜치로 전환
- 현재까지의 OCR 작업을 WIP 커밋으로 저장
- 나중에 git commit --amend로 작업 재개 예정