# PTCGP 봇 프로젝트 컨텍스트

## 프로젝트 개요
포켓몬 트레이딩 카드 게임 갓팩(God Pack) 및 20% 팩 관리를 위한 Discord 봇 시스템

## 현재 아키텍처
- **병렬 실행 구조**: 여러 봇이 동시에 실행되며 각자의 기능 담당
  - `src/bots/Poke.py`: ~~GitHub Gist 기반~~ → **로컬 파일 기반** (GISTAdapter 사용) (Group7, Group8)
  - `src/bots/Poke2.py`: 메인 갓팩 관리 봇 (파일 기반, 슬래시 명령어)
  - `src/bots/Poke20.py`: 20% 팩 전용 봇 (Poke2.py 기반)
  - `src/bots/Poke3.py`: 포럼 스레드 관리 특화 (Group1, Group3, Group6)
  - `src/bots/Poke4.py`: 테스트용 봇

## 프로젝트 구조
```
PTCGPBKor/
├── src/
│   ├── bots/        # 봇 실행 파일들
│   ├── modules/     # 공통 모듈 (GIST, LocalFile, GISTAdapter 등)
│   └── utils/       # 유틸리티 함수
├── tests/           # 테스트 코드
├── scripts/         # 유틸리티 스크립트
├── docs/            # 프로젝트 문서
├── sessions/        # 작업 세션 기록
└── data/            # 런타임 데이터 (git 제외)
    └── poke_data/   # Poke.py 로컬 데이터 저장소
        ├── common/  # 공통 데이터 (member.json, admin.txt)
        ├── group7/  # Group7 데이터 (online.txt, godpack.json 등)
        └── group8/  # Group8 데이터
```

**📌 각 디렉토리에는 `CLAUDE.md` 파일이 있어 상세 정보를 제공합니다.**

✅ **현재 상태**: 
- 디렉토리 구조 재구성 완료
- Poke.py의 GIST → LocalFile 전환 완료 (GISTAdapter 사용)

## 주요 문제점 및 개선 방향

### 1. 통합 필요성
- 현재 여러 파일을 병렬로 실행 중 (코드 복잡도로 인한 분리)
- 명령어가 특정 봇에만 존재하여 다른 봇은 "명령어 없음" 응답
- 유지보수 어려움 및 중복 코드 존재

### 2. 20% 팩 관리 이슈 (Poke20.py)
- **문제**: 20% 팩은 출현율이 높아 모든 사용자가 친구추가 시 99명 제한 초과
- **해결 방안**:
  - 한 그룹당 최대 10명으로 제한
  - 저장 경로 분리: `data/raw` → `data/raw20`
  - 그룹 분할 로직 필요 (선착순/활동량/팩 선호도 기준)

### 3. 테스트 환경 부재
- 라이브 환경에서 직접 테스트 → 버그 발생 시 사용자 불편
- 테스트 환경 구축 필요

## 데이터 구조
- **Heartbeat 데이터**: `data/heartbeat_data/` - 사용자 활동 추적
- **사용자 프로필**: `data/user_data/` - 설정 및 정보
- **친구 목록**: 
  - Poke2.py, Poke20.py: `data/raw/`
  - Poke20.py: `data/raw/` (Old/New 구분) → `data/raw20/`로 변경 예정
- **Poke.py 데이터**: `data/poke_data/` - 로컬 파일로 전환됨
  - common/: member.json, admin.txt
  - group7/, group8/: online.txt, godpack.json, godpackCode.json

## 주요 기능
1. **사용자 모니터링**: Heartbeat로 온라인 상태, 배럭 수, 팩 선호도 추적
2. **갓팩/20% 팩 감지**: DETECT 채널에서 감지 후 자동 포럼 포스팅
3. **검증 시스템**: 커뮤니티 검증 (👍/👎 반응)
4. **친구 목록 자동 생성**: 온라인 사용자 친구 코드 수집 및 최적화
5. **목표 배럭 관리**: 사용자별 설정 및 오류 시 자동 조정

## 그룹별 채널 구조
각 그룹(Group1~Group8) 동일 구조:
- HEARTBEAT: 사용자 상태
- DETECT: 팩 감지
- POSTING: 포럼
- COMMAND: 봇 명령어
- MUSEUM: 검증된 갓팩

## 현재 논의 중인 사항
1. 봇 통합 방안 (모듈화 vs 단일 파일)
2. 20% 팩 사용자 그룹 관리 알고리즘
3. 테스트 환경 구축 방법
4. 코드 리팩토링 우선순위

## 최근 수정사항 (2025-06-04)
- **GISTAdapter 버그 수정**: TextAdapter와 JsonAdapter에 NAME 속성 추가
  - 원인: GIST의 TEXT/JSON 클래스는 FILE 클래스를 상속받아 NAME 속성을 가지고 있었으나, Adapter에서는 누락됨
  - 해결: `self.NAME = name` 추가로 `Server.FILE.NAME` 호환성 확보


## Claude Code 작업 가이드라인

### 📁 디렉토리별 CLAUDE.md 시스템

#### 왜 필요한가?
1. **컨텍스트 윈도우 한계 극복**: 전체 프로젝트를 한 번에 파악하기 어려움
2. **중복 파일 생성 방지**: 각 디렉토리 역할을 명확히 해서 비슷한 파일 생성 방지
3. **빠른 네비게이션**: 필요한 정보를 즉시 찾을 수 있음
4. **일관성 유지**: 모든 작업에서 동일한 이해도로 시작

#### 운영 원칙
- **모든 디렉토리에는 `CLAUDE.md` 파일이 존재해야 함**
- 각 CLAUDE.md는 해당 디렉토리의 역할과 파일들을 설명
- 작업 시작 시 해당 디렉토리의 CLAUDE.md 확인 필수
- 새 디렉토리 생성 시 CLAUDE.md도 함께 생성
- 구조 변경 시 관련 CLAUDE.md 업데이트

### 💬 커뮤니케이션 규칙
- **모호한 지시 → 되묻기**: "~하는 게 맞나요?"
- **잠재적 문제 → 경고**: "이렇게 하면 ~문제가 발생할 수 있습니다"
- **대안 제시**: "~하는 방법도 있는데 어떤 걸 선호하시나요?"
- **변경사항 추적**: 사용자가 수동으로 추적하므로 무단 진행 금지

### 📝 용어 약속
- `CLAUDE.md` = `클로드엠디` (프롬프트에서 사용 가능)
- 예: "클로드엠디 업데이트해줘" = "CLAUDE.md를 업데이트해줘"

### 필수 확인 사항
- [ ] 큰 변경 전 계획 수립 및 검토 요청
- [ ] 파일 삭제/이동 전 사용자 확인
- [ ] 커밋 메시지 사전 검토
- [ ] 테스트 환경에서 먼저 실행
- [ ] 작업 디렉토리의 CLAUDE.md 확인

### 금지 사항
- 확인 없는 대규모 리팩토링
- 명시적 요청 없는 파일 생성
- 검토 없는 직접 커밋
- 사용자 확인 없는 파일 삭제

### 권장 작업 패턴
1. **코드 작성 전 계획 검토** ⭐ NEW
   - 코드를 짜기 전에 먼저 계획을 사용자에게 설명
   - "이런 방향으로 진행하면 어떨까요?" 형식으로 제안
   - 사용자 피드백 받은 후 코드 작성
   - 불필요한 코드 작성과 수정 시간 절약

2. **분석 → 계획 → 검토 → 실행**
   - 현재 상태 파악
   - 구체적인 작업 계획 수립
   - 사용자 검토 및 승인
   - 단계별 실행

3. **작은 단위로 작업 분할**
   - 한 번에 하나의 기능만 수정
   - 각 단계마다 동작 확인
   - 문제 발생 시 즉시 중단

4. **컨텍스트 유지**
   - `sessions/` 디렉토리의 최신 세션 파일 확인
   - 새 세션 시작 시 `sessions/YYYY-MM-DD-sessionN.md` 생성
   - 이전 작업 내용 참조
   - 반복되는 실수 방지