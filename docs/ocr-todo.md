# OCR 프로젝트 TODO

## 📋 프로젝트 개요

### 배경
- DETECT 채널에 2개의 이미지가 첨부되어 들어오는 경우가 있음
- 두 번째 이미지에는 팩을 연 계정의 아이디와 친구 코드가 포함됨
- 현재는 텍스트 메시지에서만 정보를 추출하고 있어, 이미지 정보를 활용하지 못함

### 목적
1. 두 번째 이미지에서 OCR로 계정 정보(name, code) 추출
2. 3가지 OCR 라이브러리 성능 비교 (Tesseract, EasyOCR, PaddleOCR)
3. 가장 적합한 OCR 솔루션 선택 및 GISTAdapter 통합

### 예상 결과물
- OCR 성능 비교 리포트
- 최적화된 OCR 파이프라인
- GISTAdapter 통합 코드

## ✅ TODO 목록

### Phase 1: 환경 설정 및 기본 구조 (예상: 2-3시간)
- [ ] OCR 라이브러리 설치
  - [ ] pytesseract + tesseract 설치
  - [ ] easyocr 설치
  - [ ] paddleocr 설치
- [ ] 프로젝트 디렉토리 구조 생성
  - [ ] `scripts/ocr_testing/` 생성
  - [ ] 하위 디렉토리 구조 생성
  - [ ] CLAUDE.md 파일 작성
- [ ] 공통 인터페이스 정의
  - [ ] BaseOCREngine 추상 클래스
  - [ ] 각 엔진별 구현 클래스

### Phase 2: 테스트 데이터 준비 (예상: 3-4시간)
- [ ] 테스트 이미지 수집
  - [ ] 정상 품질 이미지 (최소 10장)
  - [ ] 저품질 이미지 (압축/흐림)
  - [ ] 다양한 해상도 이미지
  - [ ] 다양한 배경 (밝은/어두운 테마)
- [ ] 정답 데이터 레이블링
  - [ ] 각 이미지별 정확한 name, code 기록
  - [ ] JSON 형식으로 저장
- [ ] 이미지 전처리 모듈 개발
  - [ ] 그레이스케일 변환
  - [ ] 대비 조정
  - [ ] 노이즈 제거

### Phase 3: OCR 엔진 구현 (예상: 4-5시간)
- [ ] Tesseract 엔진 구현
  - [ ] 기본 OCR 기능
  - [ ] 다양한 PSM 모드 테스트
  - [ ] 언어 설정 최적화
- [ ] EasyOCR 엔진 구현
  - [ ] 기본 OCR 기능
  - [ ] GPU/CPU 모드 비교
  - [ ] 신뢰도 임계값 조정
- [ ] PaddleOCR 엔진 구현
  - [ ] 기본 OCR 기능
  - [ ] 검출/인식 파라미터 조정
  - [ ] 언어 모델 선택

### Phase 4: 성능 및 정확도 테스트 (예상: 3-4시간)
- [ ] 성능 측정 스크립트 개발
  - [ ] 처리 시간 측정
  - [ ] 메모리 사용량 측정
  - [ ] CPU 사용률 측정
- [ ] 정확도 측정 스크립트 개발
  - [ ] 문자 인식률 계산
  - [ ] 친구 코드 추출 성공률
  - [ ] 사용자명 추출 성공률
- [ ] 결과 분석 및 시각화
  - [ ] 성능 비교 차트 생성
  - [ ] 정확도 비교 표 작성
  - [ ] 실패 케이스 분석

### Phase 5: 최적화 및 통합 (예상: 2-3시간)
- [ ] 최적 OCR 엔진 선택
- [ ] 전처리 파이프라인 최적화
- [ ] 패턴 매칭 로직 개선
  - [ ] 16자리 친구 코드 정규식
  - [ ] 사용자명 추출 로직
- [ ] Poke.py 통합
  - [ ] OCRProcessor 모듈 추가
  - [ ] GISTAdapter의 found_GodPack/found_Pseudo 수정
  - [ ] 파일 큐 기반 처리 구현
  - [ ] 5초 주기 확인 로직 추가
  - [ ] 폴백 로직 구현

### Phase 6: 테스트 및 문서화 (예상: 2시간)
- [ ] 통합 테스트
  - [ ] 실제 Discord 메시지로 테스트
  - [ ] 다양한 시나리오 테스트
- [ ] 문서 작성
  - [ ] 사용 가이드
  - [ ] API 문서
  - [ ] 트러블슈팅 가이드

## 🔄 의사결정 기록

### 2025-06-07 초기 계획
- **결정**: 3가지 OCR 라이브러리 모두 테스트하기로 결정
- **이유**: 각 라이브러리마다 장단점이 있어 실제 데이터로 비교 필요
- **대안**: 단일 라이브러리만 사용 → 거부됨 (최적 솔루션 확인 필요)

### 2025-06-07 구현 방식 결정
- **결정**: 모듈화 + 파일 기반 큐 + 주기적 확인 방식 채택
- **이유**: 
  - 비동기 처리는 디버깅이 어려움
  - 추가 프로그램 설치 최소화 필요 (Redis, RabbitMQ 제외)
  - Windows/Mac 크로스 플랫폼 호환성 필요
  - 봇을 가볍게 유지하면서도 안정적인 처리 필요
- **검토한 대안들**:
  - 동기식: 봇이 멈춤 → 거부
  - 순수 비동기: 디버깅 어려움 → 거부
  - Threading: GIL 문제, 디버깅 어려움 → 거부
  - 메시지 큐 시스템: 추가 설치 필요 → 거부
- **최종 선택 이유**:
  - 파일 기반으로 상태 추적 용이
  - 별도 프로세스로 봇 안정성 확보
  - 모듈화로 독립적 테스트 가능

## 🏗️ 구현 아키텍처

### 전체 구조
```
Poke.py (메인 봇)
    ├── GISTAdapter
    │   └── found_GodPack() → OCR 필요 시 큐에 추가
    ├── OCRProcessor (모듈)
    │   ├── add_to_queue() → 작업 등록
    │   └── check_completed() → 완료 확인
    └── @tasks.loop(seconds=5)
        └── OCR 결과 확인 및 포스팅

process_single_ocr.py (별도 프로세스)
    └── OCR 수행 및 결과 저장
```

### 데이터 흐름
1. DETECT 채널 메시지 수신 (2개 이미지)
2. 텍스트 파싱 + OCR 큐 등록
3. subprocess.Popen으로 OCR 워커 실행
4. 봇은 즉시 다음 작업 진행 (멈추지 않음)
5. OCR 워커가 백그라운드에서 처리
6. 5초마다 완료된 작업 확인
7. 완료된 작업 발견 시 포럼 포스팅

### 파일 구조
```
ocr_queue/              # 대기 중인 OCR 작업
├── {message_id}.json   # 작업 정보 (image_url, inform 등)
ocr_completed/          # 완료된 OCR 결과
├── {message_id}.json   # 최종 결과 (merged inform)
```

## 📊 진행 상황

### 현재 상태: 설계 완료
- [x] 프로젝트 계획 수립
- [x] TODO 문서 작성
- [x] 구현 방식 결정 (모듈화 + 파일 큐)
- [x] 아키텍처 설계 완료
- [ ] OCRProcessor 모듈 구현
- [ ] 실제 작업 시작

### 블로커 및 이슈
- 아직 없음

## 🧪 테스트 결과 요약

### 성능 비교 (추후 업데이트)
| OCR 엔진 | 평균 처리 시간 | 메모리 사용량 | CPU 사용률 |
|----------|---------------|--------------|-----------|
| Tesseract | - | - | - |
| EasyOCR | - | - | - |
| PaddleOCR | - | - | - |

### 정확도 비교 (추후 업데이트)
| OCR 엔진 | 문자 인식률 | 친구 코드 성공률 | 사용자명 성공률 |
|----------|------------|----------------|---------------|
| Tesseract | - | - | - |
| EasyOCR | - | - | - |  
| PaddleOCR | - | - | - |

## 📚 참고 자료

### OCR 라이브러리 문서
- [Tesseract OCR](https://github.com/tesseract-ocr/tesseract)
- [EasyOCR](https://github.com/JaidedAI/EasyOCR)
- [PaddleOCR](https://github.com/PaddlePaddle/PaddleOCR)

### 유용한 코드 예제
```python
# 친구 코드 패턴 매칭 (16자리 숫자)
import re
friend_code_pattern = r'\b\d{16}\b'

# 이미지 전처리 예제
import cv2
gray = cv2.cvtColor(image, cv2.COLOR_BGR2GRAY)
thresh = cv2.threshold(gray, 0, 255, cv2.THRESH_BINARY | cv2.THRESH_OTSU)[1]
```

### 주의사항
- OCR은 CPU/GPU 집약적 작업이므로 비동기 처리 필수
- 이미지 품질이 OCR 성공률에 큰 영향
- 한글 인식이 필요한 경우 별도 설정 필요

## 📝 메모
- 계획은 진행하면서 수정될 수 있음
- 각 Phase 완료 시 이 문서 업데이트 필요
- 예상치 못한 이슈 발생 시 의사결정 기록에 추가